on:
  issues:
    types: [labeled]

jobs:
  automate_invite:
    runs-on: ubuntu-latest
    steps:
      - name: Check if user is a member
        id: check_membership
        run: |
          # Extract username from the issue title or body
          USERNAME=$(echo "${{ github.event.issue.title }}" | sed -E 's/.*@([[:alnum:]_-]+).*/\1/')
          if [ -z "$USERNAME" ]; then
            USERNAME=$(echo "${{ github.event.issue.body }}" | sed -E 's/.*@([[:alnum:]_-]+).*/\1/')
          fi
          # Check if the user is already a member
          if curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/orgs/GDSC-RVTTI/members/$USERNAME" | grep -q 200; then
            echo "::set-output name=already_member::true"
          else
            echo "::set-output name=already_member::false"
          fi

      - name: Invite on label
        if: steps.check_membership.outputs.already_member != 'true'
        uses: vj-abigo/invite-on-label@v1.2
        with:
          organization: GDSC-RVTTI
          label: Invitation to the community
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          comment: "<b>Invitation sent to join GDSC RVTTI. Welcome to the community ðŸŽ‰</b><br><br>Don't forget after accepting to make it public so it appears on your GitHub profile for everyone else to see. You can do this by finding your name in the GitHub organisation list and change the dropdown to public https://github.com/orgs/GDSC-RVTTI/people<br>"
        env:
          INVITE_TOKEN: ${{ secrets.INVITE_TOKEN }}

